<html>

  <head>

    <!-- Import React -->
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>

  <body>
    <script type="text/babel">

    function generateItem (name, costFunction, impactFunction) {
      return {
        count: 0,
        name: name,
        cost: costFunction,
        impact: impactFunction,
      }
    }

      function ProductivityButton (props) {
        return (
          <div className="productivity-button">
            <button onClick={props.click}>Complete Task(s)</button>
          </div>
        )
      }

      function Stat (props) {
        return (
          <div className="stats-panel-item">{props.name}: {props.count}</div>
        )
      }

      function AdvancedStat (props) {
        return (
          <div className="stats-panel-item">{props.item.name}: {props.item.count}</div>
        )
      }

      function Logo (props) {
        return (
          <div className="logo">Productivity Counter</div>
        )
      }

      function StatsPanel (props) {
        return (
          <div className="stats-panel">
            <Logo />
            <Stat name="Tasks" count={props.tasksCount} />
            <Stat name="Productivity" count={props.productivityCount} />
            <AdvancedStat item={props.items['Legal Pads']} />
            <AdvancedStat item={props.items['Todo Apps']} />
            <AdvancedStat item={props.items['Multitasking']} />
            <AdvancedStat item={props.items['Python Scripts']} />
            <ProductivityButton click={props.click}/>
          </div>
        )
      }

      function UpgradeItem (props) {
        return (
          <div className="upgrade-item" onClick={ () => props.buyItem(props.item) }>
            <div className="task-text">{ props.item.name } (Costs { props.item.cost(props.item) } productivity.)</div>
          </div>
        )
      }

      function UpgradePanel (props) {
        return (
          <div className="upgrade-panel">
            <img src="backdrop.jpg" style={{width: 100 + "%"}}/>
            <UpgradeItem item={ props.items['Legal Pads'] } buyItem={ props.buyItem } />
            <UpgradeItem item={ props.items['Todo Apps'] } buyItem={ props.buyItem } />
            <UpgradeItem item={ props.items['Multitasking'] } buyItem={ props.buyItem } />
            <UpgradeItem item={ props.items['Python Scripts'] } buyItem={ props.buyItem } />
          </div>
        )
      }

      class App extends React.Component {
        constructor (props) {
          super(props)
          this.state = {
            tasksCount: 100,
            productivityCount: 100,
            items: {
              'Legal Pads': generateItem(
                'Legal Pads',
                item => item.count + 1,
                item => {
                  return { tasks: item.count }
                },
              ),
              'Todo Apps': generateItem(
                'Todo Apps',
                item => item.count * 35 + 35,
                item => {
                  return { tasks: item.count * 5 }
                },
              ),
              'Multitasking': generateItem(
                'Multitasking',
                item => 50 * item.count ** 2 + 100,
                item => {
                  return {}
                },
              ),
              'Python Scripts': generateItem(
                'Python Scripts',
                item => item.count * 3500 + 1000,
                item => {
                  return { productivity: item.count ** 3 }
                },
              ),
            }
          }
          this.tick = this.tick.bind(this)
          this.click = this.click.bind(this)
          this.buyItem = this.buyItem.bind(this)

          window.setInterval(this.tick, 1000);
        }

        buyItem (item) {
          const cost = item.cost(item)
          if (this.state.productivityCount >= cost) {
            this.setState((currentState) => {

              // clone dictionary
              let items = {}
              for (let item in currentState.items) {
                items[item] = {}
                for (let itemParameter in currentState.items[item]) {
                  items[item][itemParameter] = currentState.items[item][itemParameter]
                  if (item == item.name && itemParameter == 'count') {
                    items[item][itemParameter] += 1
                  }
                }
              }

              return {
                productivityCount: this.state.productivityCount - cost,
                items: items
              }
            })
          }
        }

        click () {
          const conversion = Math.min(1 + this.state.items["Multitasking"].count ** 2, this.state.tasksCount)
          this.setState((currentState) => {
            return {
              tasksCount: currentState.tasksCount - conversion,
              productivityCount: currentState.productivityCount + conversion,
            }
          })
        }

        tick () {
          this.setState((currentState) => {
            var newTasksCount = currentState.tasksCount + 1
            var newProductivityCount = currentState.productivityCount

            for (let item in currentState.items) {
              if (currentState.items[item].impact(currentState.items[item]).tasks) {
                newTasksCount += currentState.items[item].impact(currentState.items[item]).tasks
              }
              if (currentState.items[item].impact(currentState.items[item]).productivity) {
                newProductivityCount += currentState.items[item].impact(currentState.items[item]).productivity
              }
            }

            return {
              tasksCount: newTasksCount,
              productivityCount: newProductivityCount,
            }
          })
        }

        render () {
          return (
          <div className="app-container">
            <StatsPanel
              tasksCount = {this.state.tasksCount}
              productivityCount = {this.state.productivityCount}
              items = {this.state.items}
              click = {this.click}
              />

            <UpgradePanel
              items = {this.state.items}
              buyItem = { this.buyItem }
            />
          </div>
          )
        }
      }

      ReactDOM.render(
        <App />,
        document.getElementById('app')
      )
    </script>

    <div id="app"></app>

  </body>

</html>
